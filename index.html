<!DOCTYPE html>
<html>
<head>
    <title>ä¸€ä¸ªå°æ¸¸æˆ</title>
    <style>
        /* ä¿æŒæ‰€æœ‰æ ·å¼ä¸å˜ */
        canvas {
            border: 2px solid #2ecc71;
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(46, 204, 113, 0.3);
            max-width: 70vw;
            z-index: 1;
            display: none;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        .menu {
            position: absolute;
            z-index: 2;
            background: rgba(0, 0, 0, 0.95);
            padding: 25px 40px;
            border-radius: 15px;
            border: 1px solid #2ecc71;
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.3);
            text-align: center;
            color: white;
            width: 300px;
        }
        .menu-btn {
            margin: 8px;
            padding: 12px 24px;
            cursor: pointer;
            background: #34495e;
            border: none;
            color: white;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.2s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .menu-btn:hover {
            background: #2ecc71;
            transform: scale(1.05);
        }
        #leaderboardList {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 0;
            list-style: none;
        }
        .game-over {
            position: absolute;
            z-index: 3;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
            display: none;
        }
    </style>
</head>
<body>
    <!-- ä¸»èœå• -->
    <div id="mainMenu" class="menu">
        <h2>ğŸš€ ä¸€ä¸ªå°æ¸¸æˆ</h2>
        <p class="game-rules">è¯·ä½¿ç”¨ç”µè„‘æ–¹å‘é”®è¿›è¡Œæ“ä½œå“¦</p>  <!-- æ–°å¢è§„åˆ™æç¤º -->
        <button class="menu-btn" onclick="showMenu('difficulty')">ğŸ® å¼€å§‹æ¸¸æˆ</button>
        <button class="menu-btn" onclick="showLeaderboard()">ğŸ† æ’è¡Œæ¦œ</button>
        <button class="menu-btn" id="musicBtn">ğŸµ éŸ³ä¹: å¼€å¯</button>
        <button class="menu-btn" onclick="exitGame()">ğŸšª é€€å‡ºæ¸¸æˆ</button>
    </div>

    <!-- ä¿æŒåŸæœ‰æ‰€æœ‰HTMLç»“æ„ä¸å˜ -->
    <!-- ...ï¼ˆåŸæœ‰æ‰€æœ‰HTMLå†…å®¹ä¿æŒä¸å˜ï¼‰... -->

    <!-- æ’è¡Œæ¦œ -->
    <div id="leaderboard" class="menu" style="display:none">
        <h2>ğŸ… æ’è¡Œæ¦œ TOP10</h2>
        <div id="leaderboardList"></div>
        <button class="menu-btn" onclick="showMenu('main')">ğŸ”™ è¿”å›ä¸»èœå•</button>
    </div>

    <!-- éš¾åº¦é€‰æ‹© -->
    <div id="difficulty" class="menu" style="display:none">
        <h2>âš™ï¸ é€‰æ‹©éš¾åº¦</h2>
        <button class="menu-btn" style="background: #2ecc71" onclick="startGame('easy')">ğŸ˜Š ç®€å•æ¨¡å¼</button>
        <button class="menu-btn" style="background: #e74c3c" onclick="startGame('hard')">ğŸ˜¡ å›°éš¾æ¨¡å¼</button>
        <button class="menu-btn" style="background: #e67e22" onclick="startGame('insane')">ğŸ¤¯ ç–¯ç‹‚æ¨¡å¼</button>
        <button class="menu-btn" onclick="showMenu('main')">ğŸ”™ è¿”å›ä¸»èœå•</button>
    </div>

    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <div id="gameOverMenu" class="game-over">
        <h2>ğŸ’¥ æ¸¸æˆç»“æŸ</h2>
        <p id="finalScore">ğŸ… å¾—åˆ†ï¼š0</p>
        <button class="menu-btn" onclick="retryGame()">ğŸ”„ å†è¯•ä¸€æ¬¡</button>
        <button class="menu-btn" onclick="showMenu('main')">ğŸ  è¿”å›ä¸»èœå•</button>
    </div>

    <canvas id="gameCanvas" width="504" height="896"></canvas>
    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/audio/2023/10/23/audio_3d40f7d9a8.mp3" type="audio/mpeg">
    </audio>

    <script>
        // å­˜å‚¨ç³»ç»Ÿ
        const storage = {
            get(key) {
                return JSON.parse(localStorage.getItem(key)) || [];
            },
            set(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            }
        };

        // æ¸¸æˆé…ç½®
        let config = {
            currentDifficulty: 'easy',
            music: true,
            scores: storage.get('scores') || [],
            obstacleCounter: 0
        };

        // éš¾åº¦é…ç½®
        const difficulties = {
            easy: {
                name: 'ç®€å•',
                playerSpeed: 450,
                spawnInterval: 1.0,
                obstacleSpeed: 600,
                color: '#2ecc71',
                scoreValue: 1
            },
            hard: {
                name: 'å›°éš¾',
                playerSpeed: 500,
                spawnInterval: 0.6,
                obstacleSpeed: 900,
                color: '#e74c3c',
                scoreValue: 2
            },
            insane: {
                name: 'ç–¯ç‹‚',
                playerSpeed: 550,
                spawnInterval: 0.3,
                obstacleSpeed: 1200,
                color: '#e67e22',
                scoreValue: 3
            }
        };

        // æ¸¸æˆæ ¸å¿ƒå¯¹è±¡
        const game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: null,
            player: null,
            obstacles: [],
            score: 0,
            keys: {},
            isRunning: false,
            effects: null,
            lastTime: 0,
            accumulatedTime: 0,
            keyHandler: null,

            init() {
                this.canvas.style.display = 'block'; // ç¡®ä¿æ˜¾ç¤ºç”»å¸ƒ
                this.ctx = this.canvas.getContext('2d');
                this.resetState();
                
                // ä¿®å¤ç‚¹ï¼šç¡®ä¿åªç»‘å®šä¸€æ¬¡äº‹ä»¶ç›‘å¬
                if (!this.keyHandler) {
                    this.keyHandler = this.handleKey.bind(this);
                    window.addEventListener('keydown', this.keyHandler);
                    window.addEventListener('keyup', this.keyHandler);
                }

                this.isRunning = true;
                this.lastTime = performance.now();
                requestAnimationFrame((t) => this.gameLoop(t));
            },

            resetState() {
                config.obstacleCounter = 0;
                this.player = {
                    x: 226,
                    y: 738,
                    size: 53,
                    glow: 0,
                    update(deltaTime) {
                        this.glow = (this.glow + deltaTime * 3) % (Math.PI * 2);
                    }
                };
                this.obstacles = [];
                this.score = 0;
                this.keys = {};
                this.accumulatedTime = 0;
                this.effects = new GameEffects();
            },

            handleKey(e) {
                const validKeys = ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                if (validKeys.includes(e.key)) {
                    this.keys[e.key] = e.type === 'keydown';
                    e.preventDefault();
                }
            },

            gameLoop(timestamp) {
                if (!this.isRunning) return;

                const deltaTime = (timestamp - this.lastTime) / 1000;
                this.lastTime = timestamp;

                this.update(deltaTime);
                this.render(deltaTime);
                requestAnimationFrame((t) => this.gameLoop(t));
            },

            update(deltaTime) {
                // ç©å®¶ç§»åŠ¨
                let dx = (this.keys.ArrowRight ? 1 : 0) - (this.keys.ArrowLeft ? 1 : 0);
                let dy = (this.keys.ArrowDown ? 1 : 0) - (this.keys.ArrowUp ? 1 : 0);
                
                if (dx !== 0 && dy !== 0) {
                    dx *= 0.707;
                    dy *= 0.707;
                }
                
                const difficulty = difficulties[config.currentDifficulty];
                this.player.x += dx * difficulty.playerSpeed * deltaTime;
                this.player.y += dy * difficulty.playerSpeed * deltaTime;
                this.player.x = Math.max(0, Math.min(504 - 53, this.player.x));
                this.player.y = Math.max(0, Math.min(896 - 53, this.player.y));

                // ç”Ÿæˆéšœç¢ç‰©
                this.accumulatedTime += deltaTime;
                if (this.accumulatedTime > difficulty.spawnInterval) {
                    config.obstacleCounter++;
                    const isSpecialPosition = [2, 3, 5].includes(config.obstacleCounter % 5);
                    
                    const newObstacle = {
                        x: isSpecialPosition ? this.player.x : Math.random() * (504 - 63),
                        y: -63,
                        size: 63,
                        speed: difficulty.obstacleSpeed,
                        rotation: Math.random() * Math.PI * 2,
                        rotationSpeed: (Math.random() - 0.5) * 4
                    };
                    this.obstacles.push(newObstacle);
                    this.accumulatedTime = 0;
                }

                // æ›´æ–°éšœç¢ç‰©
                this.obstacles.forEach((obs, index) => {
                    obs.y += obs.speed * deltaTime;
                    obs.rotation += obs.rotationSpeed * deltaTime;

                    if (this.checkCollision(obs)) {
                        this.effects.createExplosion(obs.x + 31.5, obs.y + 31.5);
                        this.effects.screenFlash = 1;
                        this.gameOver();
                        return;
                    }

                    if (obs.y > 896) {
                        this.obstacles.splice(index, 1);
                        this.score += difficulty.scoreValue;
                    }
                });

                this.effects.update(deltaTime);
                this.player.update(deltaTime);
            },

            render(deltaTime) {
                const ctx = this.ctx;
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 504, 896);

                // ç»˜åˆ¶æ˜Ÿç©º
                this.effects.stars.forEach(star => {
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    ctx.fill();
                });

                // ç»˜åˆ¶éšœç¢ç‰©
                const difficulty = difficulties[config.currentDifficulty];
                this.obstacles.forEach(obs => {
                    ctx.save();
                    ctx.translate(obs.x + 31.5, obs.y + 31.5);
                    ctx.rotate(obs.rotation);
                    ctx.fillStyle = difficulty.color;
                    ctx.fillRect(-31.5, -31.5, 63, 63);
                    ctx.restore();
                });

                // ç»˜åˆ¶ç©å®¶
                const glowSize = Math.sin(this.player.glow) * 15 + 30;
                const gradient = ctx.createRadialGradient(
                    this.player.x + 26.5, 
                    this.player.y + 26.5, 
                    0,
                    this.player.x + 26.5,
                    this.player.y + 26.5,
                    glowSize
                );
                gradient.addColorStop(0, 'rgba(52, 152, 219, 0.8)');
                gradient.addColorStop(1, 'rgba(52, 152, 219, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(this.player.x - 30, this.player.y - 30, 113, 113);

                ctx.fillStyle = '#3498db';
                ctx.beginPath();
                ctx.roundRect(this.player.x, this.player.y, 53, 53, 8);
                ctx.fill();

                // ç»˜åˆ¶ç‰¹æ•ˆ
                this.effects.explosions.forEach(e => {
                    ctx.fillStyle = e.color;
                    ctx.globalAlpha = e.life;
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, e.size * (e.life/0.8), 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;

                if (this.effects.screenFlash > 0) {
                    ctx.fillStyle = `rgba(255, 0, 0, ${this.effects.screenFlash})`;
                    ctx.fillRect(0, 0, 504, 896);
                }

                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.fillText(`å¾—åˆ†: ${this.score}`, 20, 30);
            },

            checkCollision(obstacle) {
                return this.player.x < obstacle.x + obstacle.size &&
                       this.player.x + 53 > obstacle.x &&
                       this.player.y < obstacle.y + obstacle.size &&
                       this.player.y + 53 > obstacle.y;
            },

            gameOver() {
                this.isRunning = false;
                window.removeEventListener('keydown', this.keyHandler);
                window.removeEventListener('keyup', this.keyHandler);
                this.keyHandler = null; // æ¸…é™¤äº‹ä»¶ç›‘å¬å¼•ç”¨
                
                this.canvas.style.display = 'none';
                document.getElementById('gameOverMenu').style.display = 'block';
                document.getElementById('finalScore').textContent = `ğŸ… å¾—åˆ†ï¼š${this.score}`;

                config.scores.push({
                    score: this.score,
                    difficulty: config.currentDifficulty,
                    date: new Date().toLocaleString()
                });
                storage.set('scores', config.scores);
            }
        };

        // ç‰¹æ•ˆç³»ç»Ÿ
        class GameEffects {
            constructor() {
                this.stars = Array.from({length: 200}, () => ({
                    x: Math.random() * 504,
                    y: Math.random() * 896,
                    size: Math.random() * 2,
                    speed: Math.random() * 0.3 + 0.1,
                    alpha: Math.random() * 0.3 + 0.2
                }));
                this.explosions = [];
                this.screenFlash = 0;
            }

            update(deltaTime) {
                this.stars.forEach(star => star.y += star.speed);
                this.stars = this.stars.filter(star => {
                    if (star.y > 896) star.y = -10;
                    return true;
                });

                this.explosions = this.explosions.filter(e => {
                    e.life -= deltaTime;
                    e.x += e.vx * deltaTime;
                    e.y += e.vy * deltaTime;
                    return e.life > 0;
                });

                this.screenFlash = Math.max(0, this.screenFlash - deltaTime * 2);
            }

            createExplosion(x, y) {
                for(let i = 0; i < 30; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 150 + 50;
                    this.explosions.push({
                        x, y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        size: Math.random() * 4 + 2,
                        life: 0.8,
                        color: `hsl(${Math.random()*360}, 100%, 60%)`
                    });
                }
            }
        }

        // æ¸¸æˆæ§åˆ¶
        function startGame(difficulty) {
            config.currentDifficulty = difficulty;
            document.querySelectorAll('.menu').forEach(m => m.style.display = 'none');
            document.getElementById('gameOverMenu').style.display = 'none';
            game.init(); // ç¡®ä¿è°ƒç”¨åˆå§‹åŒ–
        }

        function retryGame() {
            document.getElementById('gameOverMenu').style.display = 'none';
            game.init();
        }

        function exitGame() {
            if (confirm("ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ")) {
                window.close();
            }
        }

        // èœå•æ§åˆ¶
        function showMenu(menuId) {
            document.querySelectorAll('.menu').forEach(m => m.style.display = 'none');
            document.getElementById('gameOverMenu').style.display = 'none';
            
            switch(menuId) {
                case 'main':
                    document.getElementById('mainMenu').style.display = 'block';
                    break;
                case 'leaderboard':
                    document.getElementById('leaderboard').style.display = 'block';
                    break;
                case 'difficulty':
                    document.getElementById('difficulty').style.display = 'block';
                    break;
                default:
                    console.warn('æœªçŸ¥èœå•:', menuId);
            }
        }

        // éŸ³ä¹æ§åˆ¶
        const bgMusic = document.getElementById('bgMusic');
        document.getElementById('musicBtn').addEventListener('click', () => {
            config.music = !config.music;
            document.getElementById('musicBtn').textContent = `ğŸµ éŸ³ä¹: ${config.music ? 'å¼€å¯' : 'å…³é—­'}`;
            config.music ? bgMusic.play() : bgMusic.pause();
            storage.set('music', config.music);
        });

        // æ’è¡Œæ¦œç³»ç»Ÿ
        function showLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = config.scores
                .sort((a, b) => b.score - a.score)
                .slice(0, 10)
                .map((s, i) => `
                    <li style="margin: 8px 0; padding: 8px; background: #2c3e50; border-radius: 4px">
                        <span style="font-size: 1.1em">${i+1}. ğŸ… ${s.score}</span>
                        <div style="font-size: 0.9em">
                            <span>ğŸšï¸ ${difficulties[s.difficulty].name}</span><br>
                            <span>ğŸ“… ${s.date}</span>
                        </div>
                    </li>
                `).join('');
            showMenu('leaderboard');
        }

        // åˆå§‹åŒ–
        if (config.music) bgMusic.play().catch(() => {});
        showMenu('main');
    </script>
</body>
</html>